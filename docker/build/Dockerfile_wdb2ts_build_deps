# Installs the dependencies necessary to compile the wdb2ts web application and dependencies from source. 
# Tag this image as metie:wdb2ts_build_deps
#
# This makes the build dependencies for wdb2ts-1.3.28c and postgresql-9.6 with libpqxx-5.0.1
#
# Start from a centos7 image
ARG         MYAPP_REPO=centos
ARG         MYAPP_IMAGE=7
ARG         MYAPP_SOURCE=$MYAPP_REPO:$MYAPP_IMAGE
FROM        $MYAPP_SOURCE

# Install the required packages

# First update yum and install epel repo
RUN            yum -y update \
            && yum -y --enablerepo=extras install epel-release 

# Install postgresql repo and disable all but pgdg96.  Then install postgresql96 along with libpqxx-devel
RUN            yum -y install https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm \
            && yum-config-manager --disable pgdg9\[0-5\] pgdg1\* \
            && yum -y install libpqxx-devel

# Install the necessary build packages
RUN            yum -y install make automake autoconf cmake3 gcc gcc-c++ \
            gcc-arm-linux-gnu.x86_64 \
            glib-devel glib2-devel \
            autoconf-archive 
RUN            yum -y install \
            boost-devel boost-thread boost-filesystem boost-regex boost-program-options \
            boost-date-time boost-system boost-test 
RUN            yum -y install \
            log4cpp-devel gcc-gfortran
RUN            yum -y install \
            git 
RUN            yum -y install \
            proj-devel
RUN            yum -y install \
            httpd httpd-devel
RUN            yum -y install \
            gtest-devel
RUN            yum -y install \
            libtool 
RUN            yum -y install \
            libxml2-devel xmlto
#RUN            yum -y install \
#            file which
#RUN            yum -y install \
#            cppunit-devel
#            udunits2.x86_64 udunits2-devel.x86_64 doxygen 
# proj 
#            geos-devel \
#RUN            yum -y install \
#            readline-devel.x86_64 readline.x86_64 
#RUN            yum -y install \
#            cppunit-devel log4cpp-devel udunits2.x86_64 udunits2-devel.x86_64 doxygen 
#RUN            yum -y install \
#            netcdf help2man 
#RUN            yum -y install \
#            rsync freetype-devel freetype 
#RUN            yum -y install \
#            qt-devel byacc graphviz 
#RUN            yum -y install \
#            bison libpng-devel libjpeg-turbo-devel \
#            ftgl-devel 
#RUN            yum -y install \
#            libgeotiff-devel 
#RUN            yum -y install \
#            mesa-libGL-devel mesa-libGLU-devel \
#            qt-devel 
#RUN            yum -y install \
#            epel-release 
#RUN            yum -y install \
#            xmlto 
#RUN            yum -y install \
#            udunits2.x86_64 udunits2-devel.x86_64 
#RUN            yum -y install \
#            libxml2-devel \
#            netcdf-devel \
#            help2man 
#RUN            yum -y install \
#            rsync wget 
#RUN            yum -y install \
#            python36-devel python2-numpy 
#RUN            yum -y install \
#            eccodes eccodes-devel 

## Install libpqxx-devel-5.0.1
#RUN            yum -y install libpqxx-devel

#RUN         yum downgrade -y  libgeotiff-1.2.5 libgeotiff-devel-1.2.5
#COPY        build/postgis-2.0.7-2.el7.x86_64.rpm /usr/local/src/
#RUN         yum -y install /usr/local/src/postgis-2.0.7-2.el7.x86_64.rpm
## Postgis SQL files are expected in /usr/share/pgsql/contrib
#RUN            cd /usr/pgsql-9.6/share/contrib/ \
#            && ln -s postgis-2.0 postgis \
#            && cp postgis-64.sql postgis/postgis.sql


#
## Run supervisord at loglevel debug
#RUN            sed -i 's/loglevel=info/loglevel=debug/g' /etc/supervisord.conf

## Postgis initialise a postgresql server
#RUN            rm -rfv /var/lib/pgsql/data \
#            && su - postgres -c '/usr/pgsql-9.6/bin/initdb -D /var/lib/pgsql/data/' \
#
## All the work happens in /usr/local
#WORKDIR        /usr/local/src
#
## Everything will be installed to /usr/local/lib64 .  This allows for easy installation to a runtime container.
#RUN            echo /usr/local/lib64 > /etc/ld.so.conf.d/liblocal.conf \
#            && ldconfig 

## Copy the postgresql-9.6 path
#COPY        etc/profile.d/pgsql-96.sh /etc/profile.d/
